
#cloud-config
autoinstall:
  updates: security
  apt:
    disable_components: [restricted,multiverse,universe]
    disable_suites: [backports,security,updates,main,jammy]
  identity:
    hostname: zarf-boots
    password: "$6$45rn4zLWI0EG.EIW$NP5d0VfcJNcw1n9owoKsk8PpaQ20FmHyO6CK4/yG9zXmKwgquxqZBM.qGB6WrYdv1.SX9fK7a9WKWqrFvD6m/1"
    realname: Admin
    username: admin
  refresh-installer:
    update: no
  ssh:
    allow-pw: true
    install-server: true
  storage:
    layout:
      name: lvm
  # packages:
  #  - net-tools
  late-commands:
    - |
      partition=$(
        lsblk -o name,label | grep 'zarf-boots' \
          | awk '{print $1}' | grep -Po '[a-zA-Z0-9]*'
      )
      zarfsrc="/media/zarfboots"
      mkdir -p "$zarfsrc"
      mount "/dev/$partition" "$zarfsrc"

      zarfdst="/target/zarfboots"
      mkdir -p "$zarfdst"
      cp -R "$zarfsrc" "$zarfdst"

      cp "$zarfdst/firstboot.sh" /target/bin/firstboot.sh
      cp "$zarfdst/runonce.service" /target/etc/systemd/system/runonce.service

      curtin in-target --target=/target -- systemctl enable runonce.service

  version: 1