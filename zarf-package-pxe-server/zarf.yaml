kind: ZarfPackageConfig
metadata:
  name: zarf-pxe
  description: "Zarf package for PXE server"
  # architecture: amd64

variables:
  - name: IPSTART
    default: 192.168.0.100
  - name: IPEND
    default: 192.168.0.200
  - name: SUBNET
    default: 255.255.255.0

  # Paths to the tftp-hosted boot files (from Ubuntu ISO)
  # - name: KERNEL_PATH
  #   default: ./vmlinuz
  # - name: GRUBCFG_PATH
  #   default: ./grub.cfg
  # - name: INITRD_PATH
  #   default: ./initrd
  # - name: FONT_PATH
  #   default: ./unicode.pf2
  # - name: GRUBEFI_PATH
  #   default: ./grubx64.efi
  # - name: BOOTEFI_PATH
  #   default: ./bootx64.efi

components:
  - name: root-check
    required: true
    actions:
      onDeploy:
        before:
          - cmd: if [ "$(id -u)" -ne 0 ]; then echo "Please run as root." >&2; exit 1; fi

  - name: iso
    required: true
    actions:
      onDeploy:
        after:
          - cmd: |
              mkdir -p /httpboot/
              mkdir -p /tftpboot/init/
              mkdir -p /tftpboot/boot/uefi/
              mkdir -p /tftpboot/grub/fonts/
              mkdir -p /tftpboot/init/
              mkdir -p ./ubuntu-iso/
              mount -o loop /httpboot/isos/ubuntu22.iso ./ubuntu-iso/
              cp -p ./ubuntu-iso/casper/vmlinuz /tftpboot/init/
              cp -p ./ubuntu-iso/casper/initrd /tftpboot/init/
              dpkg-deb -R ./ubuntu-iso/pool/main/g/grub2-signed/grub-efi-amd64-signed_1.180+2.06-2ubuntu7_amd64.deb ./grub-efi-amd64
              dpkg-deb -R ./ubuntu-iso/pool/main/s/shim-signed/shim-signed_1.51+15.4-0ubuntu9_amd64.deb ./shim-signed
              cp -p ./grub-efi-amd64/usr/lib/grub/x86_64-efi-signed/grubnetx64.efi.signed /tftpboot/grubx64.efi
              cp -p ./shim-signed/usr/lib/shim/shimx64.efi.signed /tftpboot/boot/uefi/bootx64.efi
              cp -p ./ubuntu-iso/boot/grub/fonts/unicode.pf2 /tftpboot/grub/fonts/
              touch /httpboot/roles/zarf-games/meta-data
              chmod -R 755 /httpboot/
    files:
      - source: https://releases.ubuntu.com/22.04/ubuntu-22.04.1-live-server-amd64.iso
        target: /httpboot/isos/ubuntu22.iso
      - source: role-zarf-games.yml
        target: /httpboot/roles/zarf-games/user-data

  - name: zarf-pxe
    required: true
    manifests:
      - name: zarf-pxe
        namespace: zarf-pxe
        files:
          - manifests/deployment.yaml
          - manifests/grubconfig.yaml
          - manifests/dnsmasqconfig.yaml
    images:
      - "ghcr.io/ferrarimarco/pxe:master"
      - "nginx:1.23.3"
